#!/usr/bin/env bash
# shellcheck disable=SC2086,SC2155
set -o errexit
set -o pipefail
set -o nounset

# ── Required env vars ───────────────────────────────────────────────────────────
# URL           – API endpoint to poll
# INTERVAL      – Seconds to wait between polls
# TIMEOUT       – Maximum seconds before the script gives up
# DATABASE_URL  – psql connection string
# BATCH_NUMBER  – l1_batch_number to look up in the DB
# ────────────────────────────────────────────────────────────────────────────────

START_TIME="$(date +%s)"
echo "URL: ${URL}"

trim() { awk '{$1=$1;print}'; }  # quick whitespace-stripper

while true; do
  # ── timeout guard ────────────────────────────────────────────────────────────
  ELAPSED_TIME="$(( $(date +%s) - START_TIME ))"
  if [[ "${ELAPSED_TIME}" -ge "${TIMEOUT}" ]]; then
    echo "Timeout (${TIMEOUT}s) reached. Failing CI…"
    exit 1
  fi

  # ── poll the API ─────────────────────────────────────────────────────────────
  RESPONSE="$(curl --silent --request POST \
                   --url "${URL}" \
                   --header 'Content-Type: application/json' \
                   --data '{
                     "jsonrpc": "2.0",
                     "id": 1,
                     "method": "zks_getBlockDetails",
                     "params": [1]
                   }')"

  EXECUTED_AT="$(echo "${RESPONSE}" | jq -r '.result.executedAt')"

  # ── always query DB so we can evaluate both conditions together ──────────────
  DB_STATUS="$(psql "${DATABASE_URL}" -qtA \
    -c "SELECT status FROM proof_compression_jobs_fri \
        WHERE l1_batch_number = ${BATCH_NUMBER} LIMIT 1;" \
    | trim)"

  # ── success when *both* conditions are satisfied ────────────────────────────
  if [[ "${EXECUTED_AT}" != "null" && -n "${EXECUTED_AT}" \
        && "${DB_STATUS}" == "sent_to_server" ]]; then
    echo "Success: executedAt=${EXECUTED_AT}, DB status=${DB_STATUS}"
    exit 0
  fi

  echo "Waiting… executedAt=${EXECUTED_AT:-null}, DB status=${DB_STATUS}. Retrying in ${INTERVAL}s."
  sleep "${INTERVAL}"
done
